---
interface Props {
  targetNumber: number;
  duration?: number;
  prefix?: string;
  suffix?: string;
  className?: string;
}

const { targetNumber, duration = 2, prefix = "", suffix = "", className = "" } = Astro.props;
---

<span 
  class={`counter ${className}`}
  data-target={targetNumber}
  data-duration={duration}
  data-prefix={prefix}
  data-suffix={suffix}
>
  0
</span>

<script>
  import { CountUp } from 'countup.js';

  function initCounters() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const counters = document.querySelectorAll('.counter');

    // Si prefiere movimiento reducido, mostrar nÃºmeros directamente
    if (prefersReducedMotion) {
      counters.forEach(counter => {
        const el = counter as HTMLElement;
        const target = el.dataset.target || '0';
        const prefix = el.dataset.prefix || '';
        const suffix = el.dataset.suffix || '';
        el.textContent = `${prefix}${parseInt(target).toLocaleString()}${suffix}`;
      });
      return;
    }

    const observerOptions = {
      threshold: 0.5,
      rootMargin: '50px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const counter = entry.target as HTMLElement;
          const target = parseInt(counter.dataset.target || '0');
          const duration = parseFloat(counter.dataset.duration || '2');
          const prefix = counter.dataset.prefix || '';
          const suffix = counter.dataset.suffix || '';

          const countUp = new CountUp(counter, target, {
            duration: duration,
            prefix: prefix,
            suffix: suffix,
            useEasing: true,
            useGrouping: true,
          });

          if (!countUp.error) {
            countUp.start();
          }

          observer.unobserve(counter);
        }
      });
    }, observerOptions);

    counters.forEach(counter => observer.observe(counter));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCounters);
  } else {
    initCounters();
  }
</script>
